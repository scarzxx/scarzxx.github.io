<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moderní RSS Čtečka se Záložkami</title>
    <style>
        :root {
            /* Tmavý Režim */
            --bg-color: #1a1d22; /* Tmavě modrošedá */
            --text-color: #e0e0e0; /* Světle šedá pro text */
            --card-bg: #252a31; /* Pozadí karet, o něco světlejší než tělo */
            --border-color: #3a414c; /* Barva ohraničení */
            --accent-color: #4e9aef; /* Světlejší modrá pro akcenty */
            --accent-color-darker: #3a7bc8; /* Tmavší odstín akcentní barvy pro hover */
            --header-color: #cdd5de; /* Barva hlavních nadpisů */
            --secondary-text-color: #a0a7b2; /* Pro méně důležitý text (popisky) */
            --subtle-text-color: #7a828e; /* Pro velmi jemný text (datum, metadata) */
            
            --shadow-color: rgba(0, 0, 0, 0.3); /* Stín pro karty */
            --shadow-hover-color: rgba(0, 0, 0, 0.45); /* Stín pro karty při hoveru */
            
            --placeholder-bg: #30363e; /* Pozadí pro placeholder obrázku */
            --placeholder-text: #6a737e; /* Text placeholderu obrázku */
            
            --error-bg: #4d1f1f; /* Pozadí chybové zprávy */
            --error-border: #a03030; /* Ohraničení chybové zprávy */
            --error-text: #f5c5c5; /* Text chybové zprávy */
            
            --info-bg: #30363e; /* Pozadí informační zprávy */
            --info-border: #4a515c; /* Ohraničení informační zprávy */
            --info-text: #9da5b0; /* Text informační zprávy */

            --font-family-system: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
        }

        html {
            box-sizing: border-box;
            scroll-behavior: smooth;
        }

        *, *::before, *::after {
            box-sizing: inherit;
        }

        body {
            font-family: var(--font-family-system);
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            text-align: center;
            color: var(--header-color);
            margin-bottom: 30px;
            font-size: 2.2em;
            font-weight: 600;
        }

        #loading-message {
            text-align: center;
            font-size: 1.2em;
            color: var(--subtle-text-color);
            padding: 20px;
            transition: opacity 0.5s ease-out; /* Pro plynulé zmizení */
        }

        #loading-message.hidden {
            opacity: 0;
            height: 0;
            padding: 0; /* Aby nezabíralo místo po skrytí */
            overflow: hidden;
        }


        /* Styly pro záložky */
        .tabs-navigation {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 25px;
            border-bottom: 1px solid var(--border-color);
            gap: 4px; /* Mezery mezi tlačítky */
        }

        .tab-button {
            padding: 12px 24px;
            cursor: pointer;
            border: none;
            background-color: transparent;
            font-size: 1em;
            font-weight: 500;
            color: var(--accent-color);
            border-bottom: 3px solid transparent;
            margin-bottom: -1px; /* Aby překryl border-bottom .tabs-navigation */
            transition: color 0.3s ease, border-bottom-color 0.3s ease, background-color 0.2s ease;
            border-top-left-radius: 6px;
            border-top-right-radius: 6px;
        }

        .tab-button:hover {
            color: var(--accent-color-darker);
            background-color: rgba(78, 154, 239, 0.08); /* Jemné pozadí při hoveru */
        }

        .tab-button.active {
            color: var(--header-color);
            border-bottom-color: var(--accent-color-darker);
            font-weight: 600;
            background-color: rgba(78, 154, 239, 0.05);
        }

        .tab-content-panel {
            display: none;
        }

        .tab-content-panel.active {
            display: block;
        }
        
        .error-message-feed {
            color: var(--error-text);
            padding: 15px;
            background-color: var(--error-bg);
            border: 1px solid var(--error-border);
            border-radius: 6px;
            margin-top: 10px;
        }
        .no-items-message {
            color: var(--info-text);
            padding: 15px;
            background-color: var(--info-bg);
            border: 1px solid var(--info-border);
            border-radius: 6px;
            margin-top: 10px;
            text-align: center;
        }

        .rss-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px; /* Větší mezery mezi kartami */
            padding-top: 10px;
        }

        .rss-item {
            background-color: var(--card-bg);
            border-radius: 10px;
            box-shadow: 0 5px 15px var(--shadow-color);
            overflow: hidden;
            transition: transform 0.25s ease-in-out, box-shadow 0.25s ease-in-out;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border-color);
        }

        .rss-item:hover {
            transform: translateY(-6px);
            box-shadow: 0 8px 20px var(--shadow-hover-color);
        }

        .rss-item-image-container {
            width: 100%;
            height: 180px;
            background-color: var(--placeholder-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .rss-item-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .rss-item-image-placeholder-text {
            color: var(--placeholder-text);
            font-size: 1em;
        }

        .rss-item-content {
            padding: 20px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 12px; /* Pro mezery mezi titulkem, popisem a datem */
        }

        .rss-item-title {
            font-size: 1.25em;
            font-weight: 600;
            margin: 0;
        }

        .rss-item-title a {
            text-decoration: none;
            color: var(--accent-color);
            transition: color 0.2s ease;
        }

        .rss-item-title a:hover {
            text-decoration: underline;
            color: var(--accent-color-darker);
        }

        .rss-item-description {
            font-size: 0.95em;
            color: var(--secondary-text-color);
            line-height: 1.55;
            margin: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 4; /* Omezí počet řádků */
            -webkit-box-orient: vertical;
        }
        
        .rss-item-description img {
            display: none; /* Skryje obrázky v popisu, zachováno z původního kódu */
        }

        .rss-item-date {
            font-size: 0.8em;
            color: var(--subtle-text-color);
            margin-top: auto; /* Posune datum na konec karty, pokud je málo textu */
            text-align: right;
        }

        @media (max-width: 768px) {
            .tab-button {
                font-size: 0.9em;
                padding: 10px 15px;
            }
            h1 {
                font-size: 1.9em;
            }
        }
        @media (max-width: 600px) {
            .rss-grid {
                grid-template-columns: 1fr; /* Jedna karta na řádek */
            }
            h1 {
                font-size: 1.7em;
            }
            .tabs-navigation {
                justify-content: flex-start; /* Zarovnání na začátek, s wrapem se přizpůsobí */
            }
            .tab-button {
                 flex-grow: 0; /* Nechat tlačítka přirozeně velká */
                 text-align: center;
            }
             /* Pokud chcete, aby i na mobilu vyplnila šířku, pokud je málo záložek: */
            .tabs-navigation.fill-width .tab-button {
                 flex-grow: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Moje RSS Feedy</h1>
        <div id="loading-message">Načítám RSS kanály...</div>
        
        <div class="tabs-container">
            <div class="tabs-navigation" id="tabs-nav">
                <!-- Tlačítka záložek budou vložena sem JavaScriptem -->
            </div>
            <div class="tabs-content-panels" id="tabs-content">
                <!-- Obsahové panely záložek budou vloženy sem JavaScriptem -->
            </div>
        </div>
    </div>

    <script>
        const rssFeeds = [
            { name: "Kinobox Novinky", url: "https://raw.githubusercontent.com/scarzxx/kinobox-rss/refs/heads/main/feed/kinobox_novinky_rss.xml" },
            { name: "Kinobox Trendy", url: "https://raw.githubusercontent.com/scarzxx/kinobox-tmdb-rss-cz/refs/heads/main/feed/kinobox_trendy_rss.xml" },
            { name: "TMDB Populární Filmy", url: "https://raw.githubusercontent.com/scarzxx/kinobox-rss/refs/heads/main/feed/tmdb_popular_rss.xml" },
            { name: "TMDB TV Seriály", url: "https://raw.githubusercontent.com/scarzxx/kinobox-tmdb-rss-cz/refs/heads/main/feed/tmdb_tv_rss.xml" }
        ];

        const tabsNavContainer = document.getElementById('tabs-nav');
        const tabsContentContainer = document.getElementById('tabs-content');
        const loadingMessage = document.getElementById('loading-message');

        function extractImageUrlFromHtml(htmlString) {
            if (!htmlString) return null;
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlString, 'text/html');
            const img = doc.querySelector('img');
            return img ? img.src : null;
        }

        function stripHtml(html) {
            const tempDiv = document.createElement("div");
            tempDiv.innerHTML = html;
            return tempDiv.textContent || tempDiv.innerText || "";
        }

        function switchTab(activeIndex) {
            // console.log(`Switching to tab: ${activeIndex}`); // Pro ladění
            tabsNavContainer.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            tabsContentContainer.querySelectorAll('.tab-content-panel').forEach(panel => {
                panel.classList.remove('active');
            });

            const activeButton = tabsNavContainer.querySelector(`.tab-button[data-index="${activeIndex}"]`);
            const activePanel = tabsContentContainer.querySelector(`.tab-content-panel[data-index="${activeIndex}"]`);
            
            if (activeButton) activeButton.classList.add('active');
            if (activePanel) activePanel.classList.add('active');
        }

        async function fetchAndDisplayFeeds() {
            // console.log("fetchAndDisplayFeeds: Start"); // Pro ladění
            if (!rssFeeds || rssFeeds.length === 0) {
                loadingMessage.textContent = "Nebyly nakonfigurovány žádné RSS kanály.";
                loadingMessage.classList.remove('hidden'); // Ujistíme se, že je viditelná, pokud už byla skryta
                return;
            }

            rssFeeds.forEach((feed, index) => {
                const button = document.createElement('button');
                button.className = 'tab-button';
                button.textContent = feed.name;
                button.dataset.index = index;
                button.addEventListener('click', () => switchTab(index));
                tabsNavContainer.appendChild(button);

                const panel = document.createElement('div');
                panel.className = 'tab-content-panel';
                panel.dataset.index = index;
                tabsContentContainer.appendChild(panel);
            });

            if (rssFeeds.length < 4 && window.innerWidth <= 600) {
                tabsNavContainer.classList.add('fill-width');
            }

            const feedPromises = rssFeeds.map(async (feed, i) => {
                const currentPanel = tabsContentContainer.querySelector(`.tab-content-panel[data-index="${i}"]`);
                // console.log(`Fetching feed: ${feed.name}`); // Pro ladění
                
                try {
                    const response = await fetch(feed.url);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const xmlText = await response.text();
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(xmlText, "application/xml");
                    
                    // ----> KLÍČOVÁ OPRAVA ZDE <----
                    const parserError = xmlDoc.querySelector("parsererror"); 
                    if (parserError) {
                        console.error(`XML parsing error for ${feed.name}:`, parserError.textContent);
                        throw new Error(`Chyba parsování XML: ${parserError.textContent.split('\n')[0].trim()}`);
                    }
                    
                    const items = xmlDoc.querySelectorAll("item");
                    
                    if (items.length > 0) {
                        const gridElement = document.createElement('div');
                        gridElement.className = 'rss-grid';
                        
                        items.forEach(item => {
                            const title = item.querySelector("title")?.textContent || "Bez názvu";
                            const link = item.querySelector("link")?.textContent || "#";
                            const descriptionHTML = item.querySelector("description")?.textContent || "";
                            const pubDateStr = item.querySelector("pubDate")?.textContent;

                            let imageUrl = extractImageUrlFromHtml(descriptionHTML);
                            
                            if (!imageUrl) {
                                const mediaThumbnail = item.querySelector('media\\:thumbnail, thumbnail');
                                if (mediaThumbnail) imageUrl = mediaThumbnail.getAttribute('url');
                            }
                            if (!imageUrl) {
                                const enclosure = item.querySelector('enclosure[type^="image/"]');
                                if (enclosure) imageUrl = enclosure.getAttribute('url');
                            }

                            const cleanDescription = stripHtml(descriptionHTML);

                            let formattedDate = "Neznámé datum";
                            if (pubDateStr) {
                                try {
                                    const date = new Date(pubDateStr);
                                    formattedDate = date.toLocaleDateString('cs-CZ', {
                                        year: 'numeric', month: 'long', day: 'numeric'
                                    });
                                } catch (e) { console.warn(`Error parsing date for ${feed.name}: "${pubDateStr}"`, e); }
                            }
                            
                            const itemElement = document.createElement('div');
                            itemElement.className = 'rss-item';

                            const imageContainer = document.createElement('div');
                            imageContainer.className = 'rss-item-image-container';

                            if (imageUrl) {
                                const imgElement = document.createElement('img');
                                imgElement.src = imageUrl;
                                imgElement.alt = title;
                                imgElement.className = 'rss-item-image';
                                imgElement.loading = 'lazy';
                                imgElement.onerror = function() {
                                    this.remove(); 
                                    const placeholderText = document.createElement('span');
                                    placeholderText.className = 'rss-item-image-placeholder-text';
                                    placeholderText.textContent = 'Obrázek nedostupný';
                                    if (!imageContainer.querySelector('.rss-item-image-placeholder-text')) {
                                        imageContainer.appendChild(placeholderText);
                                    }
                                };
                                imageContainer.appendChild(imgElement);
                            } else {
                                const placeholderText = document.createElement('span');
                                placeholderText.className = 'rss-item-image-placeholder-text';
                                placeholderText.textContent = 'Žádný obrázek';
                                imageContainer.appendChild(placeholderText);
                            }
                            itemElement.appendChild(imageContainer);
                            
                            const contentElement = document.createElement('div');
                            contentElement.className = 'rss-item-content';

                            const titleElement = document.createElement('h3');
                            titleElement.className = 'rss-item-title';
                            const linkElement = document.createElement('a');
                            linkElement.href = link;
                            linkElement.target = "_blank";
                            linkElement.rel = "noopener noreferrer";
                            linkElement.textContent = title;
                            titleElement.appendChild(linkElement);
                            
                            const descriptionElement = document.createElement('p');
                            descriptionElement.className = 'rss-item-description';
                            descriptionElement.textContent = cleanDescription;

                            const dateElement = document.createElement('p');
                            dateElement.className = 'rss-item-date';
                            dateElement.textContent = formattedDate;

                            contentElement.appendChild(titleElement);
                            contentElement.appendChild(descriptionElement);
                            contentElement.appendChild(dateElement);
                            itemElement.appendChild(contentElement);
                            gridElement.appendChild(itemElement);
                        });
                        if (currentPanel) currentPanel.appendChild(gridElement);
                    } else {
                         const noItemsMsg = document.createElement('p');
                         noItemsMsg.className = 'no-items-message';
                         noItemsMsg.textContent = `V tomto kanálu nebyly nalezeny žádné položky.`;
                         if (currentPanel) currentPanel.appendChild(noItemsMsg);
                    }
                    return { status: 'fulfilled', name: feed.name };
                } catch (error) {
                    console.error(`Error fetching/processing RSS feed ${feed.name}:`, error);
                    const errorElement = document.createElement('p');
                    errorElement.className = 'error-message-feed';
                    errorElement.textC
